- [React中的可变性与不可变性笔记](#react中的可变性与不可变性笔记)
  - [核心概念](#核心概念)
    - [不可变数据 (Immutable Data)](#不可变数据-immutable-data)
    - [可变数据 (Mutable Data)](#可变数据-mutable-data)
    - [不可变数据操作](#不可变数据操作)
    - [可变数据操作](#可变数据操作)
  - [底层原理差异](#底层原理差异)
  - [比较操作详解](#比较操作详解)
    - [可变数据比较](#可变数据比较)
    - [不可变数据比较](#不可变数据比较)
  - [优化技术](#优化技术)
  - [React中的应用](#react中的应用)
  - [实现方式](#实现方式)
---

# React中的可变性与不可变性笔记

## 核心概念

### 不可变数据 (Immutable Data)
- 创建后不能被修改的数据结构
- React推荐使用不可变方式管理状态
- 更新时创建新的数据副本而非修改原始数据

### 可变数据 (Mutable Data)
- 可以直接修改的数据结构
- JavaScript中的对象和数组默认是可变的
- 在React中不推荐直接修改状态

### 不可变数据操作 
```jsx
// 创建新数组，而不是修改原数组
const addTodo = (todos, newTodo) => [...todos, newTodo];

// 使用setState更新状态
setTodos(prevTodos => [...prevTodos, newTodo]);
```

### 可变数据操作
```jsx
// 不推荐在React中使用
const addTodo = (todos, newTodo) => {
  todos.push(newTodo); // 直接修改原数组
  return todos;
};
```

## 底层原理差异

| 特性         | 可变数据操作           | 不可变数据操作                |
| ------------ | ---------------------- | ----------------------------- |
| **内存分配** | 直接修改原始内存位置   | 创建新的内存空间              |
| **引用**     | 保持相同的内存引用     | 生成全新的引用                |
| **示例**     | `array.push(item)`     | `newArray = [...array, item]` |
| **内存开销** | 较低，只修改已有结构   | 较高，需要创建数据副本        |
| **垃圾回收** | 不产生需回收的旧数据   | 创建需回收的旧数据实例        |
| **比较操作** | 需深度比较(O(n)复杂度) | 仅需引用比较(O(1)复杂度)      |
| **并发安全** | 可能导致竞态条件       | 天然并发安全                  |

## 比较操作详解

### 可变数据比较
- 必须进行深度比较(递归比较所有属性)
- 时间复杂度O(n)，与数据结构大小成正比
```javascript
// 深度比较示例
function deepEqual(obj1, obj2) {
  // 递归比较每个属性
  // ...递归实现代码
}
```

### 不可变数据比较
- 可通过简单引用比较(`===`)检测变化
- 时间复杂度O(1)，常数时间
```javascript
// 简单引用比较
const hasChanged = prevState !== currentState;
```

## 优化技术

为解决不可变操作的内存和性能开销：
- **结构共享**: 只复制被修改的部分(如Immutable.js)
- **持久化数据结构**: 使用树形结构优化修改
- **惰性计算**: 按需创建新数据

## React中的应用

React推荐使用不可变数据操作的原因：
1. 便于检测状态变化(通过引用比较)
2. 支持实现撤销/重做功能
3. 避免意外状态修改导致的副作用
4. 支持React的单向数据流模型
5. 优化性能(PureComponent和React.memo利用浅比较检测变化)

## 实现方式
- ES6扩展运算符: `{...obj, property: newValue}`
- Object.assign(): `Object.assign({}, obj, {property: newValue})`
- 不可变数据库: Immutable.js, immer等